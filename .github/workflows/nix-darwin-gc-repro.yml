name: Nix-Darwin GC Bug Reproduction

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test-nix-darwin-gc:
    runs-on: macos-latest
    strategy:
      matrix:
        config: [good]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Nix
      uses: cachix/install-nix-action@v27
      with:
        extra_nix_config: |
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

    - name: Build and switch
      run: |
        nix build .#darwinConfigurations.good.system
        sudo ./result/sw/bin/darwin-rebuild switch --flake .#good

    - name: Show /etc/ contents after nix-darwin installation
      run: |
        echo "=== /etc/ contents after nix-darwin installation ==="
        ls -la /etc/
        echo "=== End /etc/ contents after installation ==="

    - name: Run nix-collect-garbage
      run: |
        echo "Running nix-collect-garbage..."
        nix-collect-garbage -d
        echo "Garbage collection completed"

    - name: Show /etc/ contents after garbage collection
      run: |
        echo "=== /etc/ contents after garbage collection ==="
        ls -la /etc/
        echo "=== End /etc/ contents after GC ==="
